/**
 * Migration: Create Patient List View
 * Creates the patient_list view with resolved concept names
 * This view joins PATIENT_DIMENSION with CONCEPT_DIMENSION to provide human-readable values
 */

export const createPatientListView = {
  name: '005-create-patient-list-view',
  description:
    'Create patient_list view with resolved concept names for SEX_CD, VITAL_STATUS_CD, LANGUAGE_CD, RACE_CD, MARITAL_STATUS_CD, RELIGION_CD',
  execute: async (connection) => {
    const statements = [
      // Drop view if it exists (for idempotency)
      'DROP VIEW IF EXISTS patient_list',

      // Create the patient_list view with concept resolution
      `CREATE VIEW patient_list AS
SELECT
    PATIENT_DIMENSION.PATIENT_NUM as PATIENT_NUM,
    PATIENT_DIMENSION.PATIENT_CD as PATIENT_CD,
    PATIENT_DIMENSION.IMPORT_DATE as IMPORT_DATE,
    PATIENT_DIMENSION.VITAL_STATUS_CD as VITAL_STATUS_CD,
    CD1.NAME_CHAR as VITAL_STATUS_RESOLVED,
    PATIENT_DIMENSION.BIRTH_DATE as BIRTH_DATE,
    PATIENT_DIMENSION.DEATH_DATE as DEATH_DATE,
    PATIENT_DIMENSION.SEX_CD as SEX_CD,
    CD2.NAME_CHAR as SEX_RESOLVED,
    PATIENT_DIMENSION.AGE_IN_YEARS as AGE_IN_YEARS,
    PATIENT_DIMENSION.LANGUAGE_CD as LANGUAGE_CD,
    CD3.NAME_CHAR as LANGUAGE_RESOLVED,
    PATIENT_DIMENSION.RACE_CD as RACE_CD,
    CD4.NAME_CHAR as RACE_RESOLVED,
    PATIENT_DIMENSION.MARITAL_STATUS_CD as MARITAL_STATUS_CD,
    CD5.NAME_CHAR as MARITAL_STATUS_RESOLVED,
    PATIENT_DIMENSION.RELIGION_CD as RELIGION_CD,
    CD6.NAME_CHAR as RELIGION_RESOLVED,
    PATIENT_DIMENSION.STATECITYZIP_PATH as STATECITYZIP_PATH,
    PATIENT_DIMENSION.PATIENT_BLOB as PATIENT_BLOB,
    PATIENT_DIMENSION.UPDATE_DATE as UPDATE_DATE,
    PATIENT_DIMENSION.DOWNLOAD_DATE as DOWNLOAD_DATE,
    PATIENT_DIMENSION.SOURCESYSTEM_CD as SOURCESYSTEM_CD,
    PATIENT_DIMENSION.UPLOAD_ID as UPLOAD_ID,
    PATIENT_DIMENSION.CREATED_AT as CREATED_AT,
    PATIENT_DIMENSION.UPDATED_AT as UPDATED_AT
FROM
    PATIENT_DIMENSION
LEFT JOIN CONCEPT_DIMENSION AS CD1 ON
    CD1.CONCEPT_CD = PATIENT_DIMENSION.VITAL_STATUS_CD
LEFT JOIN CONCEPT_DIMENSION AS CD2 ON
    CD2.CONCEPT_CD = PATIENT_DIMENSION.SEX_CD
LEFT JOIN CONCEPT_DIMENSION AS CD3 ON
    CD3.CONCEPT_CD = PATIENT_DIMENSION.LANGUAGE_CD
LEFT JOIN CONCEPT_DIMENSION AS CD4 ON
    CD4.CONCEPT_CD = PATIENT_DIMENSION.RACE_CD
LEFT JOIN CONCEPT_DIMENSION AS CD5 ON
    CD5.CONCEPT_CD = PATIENT_DIMENSION.MARITAL_STATUS_CD
LEFT JOIN CONCEPT_DIMENSION AS CD6 ON
    CD6.CONCEPT_CD = PATIENT_DIMENSION.RELIGION_CD
ORDER BY PATIENT_CD`,
    ]

    // Execute each statement individually
    for (const statement of statements) {
      await connection.executeCommand(statement)
    }

    console.log('Patient list view created successfully')
  },
}
